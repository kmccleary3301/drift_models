name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            uv.lock
      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -e ".[dev,eval]"
      - name: Ruff syntax/fatal checks
        run: ruff check drifting_models scripts tests --select E9,F63,F7,F82

  runtime-preflight:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: ["ubuntu-latest", "macos-latest", "windows-latest"]
        python-version: ["3.12"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            uv.lock
      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -e ".[dev,eval]"
      - name: Runtime preflight (auto)
        run: python scripts/runtime_preflight.py --device auto --check-torchvision --strict --output-path outputs/runtime_preflight_ci/preflight_${{ matrix.os }}.json
      - name: Runtime preflight (cpu)
        run: python scripts/runtime_preflight.py --device cpu --check-torchvision --strict --output-path outputs/runtime_preflight_ci/preflight_${{ matrix.os }}_cpu.json
      - name: Upload runtime preflight artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: runtime-preflight-${{ matrix.os }}-py${{ matrix.python-version }}
          path: outputs/runtime_preflight_ci/*.json
          if-no-files-found: ignore
          retention-days: 14

  runtime-preflight-summary:
    if: always()
    needs: [runtime-preflight]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Download runtime preflight artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: runtime-preflight-*
          path: outputs/runtime_preflight_ci/collected
          merge-multiple: true
      - name: Build runtime preflight summary
        run: |
          python scripts/summarize_runtime_preflight.py \
            --input-glob "outputs/runtime_preflight_ci/collected/*.json" \
            --allow-empty \
            --output-md outputs/runtime_preflight_ci/preflight_summary.md \
            --output-json outputs/runtime_preflight_ci/preflight_summary.json
      - name: Add runtime preflight summary to job summary
        shell: bash
        run: |
          if [ -f outputs/runtime_preflight_ci/preflight_summary.md ]; then
            cat outputs/runtime_preflight_ci/preflight_summary.md >> "$GITHUB_STEP_SUMMARY"
          fi
      - name: Upload runtime preflight summary artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: runtime-preflight-summary
          path: |
            outputs/runtime_preflight_ci/preflight_summary.md
            outputs/runtime_preflight_ci/preflight_summary.json
          if-no-files-found: ignore
          retention-days: 14
      - name: Post runtime preflight summary on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const marker = "<!-- runtime-preflight-summary -->";
            const summaryPath = "outputs/runtime_preflight_ci/preflight_summary.md";
            if (!fs.existsSync(summaryPath)) {
              core.warning(`missing summary file: ${summaryPath}`);
              return;
            }
            let content = fs.readFileSync(summaryPath, "utf8");
            const maxLen = 60000;
            if (content.length > maxLen) {
              content = content.slice(0, maxLen) + "\n\n_...truncated..._";
            }
            const body = `${marker}\n${content}`;
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            });
            const existing = comments.find((comment) => {
              const isBot = comment.user && comment.user.type === "Bot";
              const hasMarker = typeof comment.body === "string" && comment.body.includes(marker);
              return isBot && hasMarker;
            });
            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }

  tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            uv.lock
      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -e ".[dev,eval]"
      - name: Run fast test suite
        run: |
          pytest -q tests/unit \
            tests/integration/test_runtime_preflight_smoke.py \
            tests/integration/test_stage2_smoke.py \
            tests/integration/test_mae_smoke.py \
            tests/integration/test_pixel_smoke.py \
            tests/integration/test_eval_fid_is_smoke.py \
            tests/integration/test_train_latent_config.py

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            uv.lock
      - name: Build package artifacts
        run: |
          python -m pip install -U pip
          pip install -e ".[dev]"
          python -m build
          twine check dist/*

  runtime-preflight-experimental:
    continue-on-error: true
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - profile: mps
            os: macos-latest
            device: mps
          - profile: rocm
            os: ubuntu-latest
            device: cuda
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            uv.lock
      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -e ".[dev,eval]"
      - name: Runtime preflight (experimental ${{ matrix.profile }})
        run: |
          python scripts/runtime_preflight.py \
            --device ${{ matrix.device }} \
            --check-compile \
            --compile-fail-action warn \
            --output-path outputs/runtime_preflight_experimental/preflight_${{ matrix.profile }}.json
      - name: Upload experimental runtime artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: runtime-preflight-experimental-${{ matrix.profile }}
          path: outputs/runtime_preflight_experimental/*.json
          if-no-files-found: ignore
          retention-days: 14
